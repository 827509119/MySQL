

# 索引

## 聚簇索引和二级索引

每个`InnoDB`表都有一个特殊的索引，称为[聚簇索引](https://dev.mysql.com/doc/refman/5.7/en/glossary.html#glos_clustered_index) ，用于存储行数据。通常，聚簇索引与[主键](https://dev.mysql.com/doc/refman/5.7/en/glossary.html#glos_primary_key)同义 。为了从查询，插入和其他数据库操作中获得最佳性能，您必须了解`InnoDB`如何使用聚簇索引为每个表优化最常见的查找和DML操作。

- 在表上定义`PRIMARY KEY` 时，`InnoDB`将其用作聚簇索引。为您创建的每个表定义一个主键。如果没有逻辑唯一且非空的列或列集，请添加一个新的 [自动递增](https://dev.mysql.com/doc/refman/5.7/en/glossary.html#glos_auto_increment) 列，其值将自动填充。

- 如果您没有`PRIMARY KEY`为表定义，MySQL会在所有`UNIQUE KEY NOT NULL`列所在的位置找到第一个索引，并将其用作聚集索引。

- 如果表没有索引`PRIMARY KEY`或没有合适的 `UNIQUE`索引，则在`InnoDB` 内部生成一个隐藏的聚集索引`GEN_CLUST_INDEX`，该索引在包含行ID值的合成列上命名 。这些行由`InnoDB`分配给该表中各行的ID排序 。行ID是一个6字节的字段，随着插入新行而单调增加。因此，按行ID排序的行实际上在插入顺序上。

  

### 聚集索引如何加快查询

通过聚集索引访问行是快速的，**因为索引搜索直接包含所有行数据的页面**。如果表很大，则与MYISAM相比，索引和数据不在一起，聚集索引体系结构通常可以节省磁盘I / O操作。

### 二级索引如何与聚簇索引相关

除聚集索引之外的所有索引都称为 [辅助索引](https://dev.mysql.com/doc/refman/5.7/en/glossary.html#glos_secondary_index)。在中`InnoDB`，辅助索引中的每个记录都包含该行的主键列以及为辅助索引指定的列。 `InnoDB`使用此主键值在聚集索引中搜索行。

如果主键较长，则辅助索引将使用更多空间，因此具有较短的主键是有利的。

## InnoDB索引的物理结构

除空间索引外，`InnoDB` 索引均为 B+ 数据结构。空间索引使用 [R树](https://dev.mysql.com/doc/refman/5.7/en/glossary.html#glos_r_tree)，[R树](https://dev.mysql.com/doc/refman/5.7/en/glossary.html#glos_r_tree)是用于索引多维数据的专用数据结构。索引记录存储在其B+树或R树数据结构的叶页中。**索引页的默认大小为16KB。**

**MySQL中B+树在添加和删除时，会通过左旋右旋，尽量保持不浪费空间。**

当将新记录插入InnoDB聚集索引时，InnoDB会尝试保留1/16的页面空间，以供将来插入和更新索引记录。如果按顺序(升序或降序)插入索引记录，则生成的索引页大约占满15/16。如果以随机顺序插入记录，页面的大小从1/2到15/16不等。（尽量保持所有数据在 一个页内，但随机插入，会导致页分裂，分裂时，会有一半的数据分裂出去——B+树分裂规则）

InnoDB在创建或重建B+树索引时执行大容量装载。这种创建索引的方法称为排序索引构建。`INNODB_FILL_FACTOR`配置选项定义在排序索引构建期间填充的每个B+树页面上的空间百分比，剩余空间保留用于将来的索引增长。空间索引不支持排序索引生成。如果InnodbFill_factor设置为100，则聚集索引页中有1/16的空间可供将来的索引增长使用。

如果InnoDB索引页的**填充因子**低于MERGE_THRESHOLD(如果未指定，则默认为50%)，InnoDB会尝试收缩索引树以释放该页。MERGE_THRESHOLD设置同时适用于B树和R树索引。有关详细信息，请参阅第14.8.12节“配置索引页的合并阈值”。

您可以在初始化MySQL实例之前设置Innodb_page_size配置选项，为MySQL实例中的所有InnoDB表空间定义页面大小。一旦定义了实例的页面大小，在不重新初始化实例的情况下就不能更改它。支持的大小为64KB、32KB、16KB(默认值)、8KB和4KB。

MySQL5.7中添加了对32KB和64KB页面大小的支持。有关详细信息，请参阅Innodb_page_size文档。

使用特定InnoDB页面大小的MySQL实例不能使用来自使用不同页面大小的实例的数据文件或日志文件。

## 排序索引的创建

**InnoDB在创建或重建索引时执行大容量装载，而不是一次插入一条索引记录。这种创建索引的方法也称为排序索引构建**。空间索引不支持排序索引生成。

### 索引构建有三个阶段。(归并排序思想)

1. 在第一阶段，扫描聚集索引，生成索引项并将其添加到排序缓冲区。当排序缓冲区变满时，条目被排序并写出到临时中间文件。这个过程也被称为“run”。
2. 在第二阶段，在将一个或多个运行写入临时中间文件的情况下，对文件中的所有条目执行合并排序。
3. 在第三个也是最后一个阶段，将排序后的条目插入到B-树中。

在引入排序索引构建之前，使用INSERT API将索引项插入到B树中，一次插入一个记录。该方法包括打开B-tree游标以查找插入位置，然后使用乐观插入将条目插入到B-tree页面中。如果由于页面已满而导致插入失败，则将执行悲观插入，这包括打开B-tree游标，并根据需要拆分和合并B-tree节点以找到条目的空间。这种“自上而下”的索引构建方法的缺点是搜索插入位置的成本以及B-tree节点的不断拆分和合并。

排序索引构建使用“自下而上”的方法构建索引。使用此方法，在B树的所有级别上都保存对最右侧叶页面的引用。分配必要B树深度的最右边的叶页，并根据条目的排序顺序插入条目。一旦叶页已满，就会将节点指针附加到父页，并为下一次插入分配一个同级叶页。此过程将继续进行，直到插入所有条目，这可能会导致最多插入到根级别。分配同级页时，将释放对先前固定的叶页的引用，并且新分配的叶页将成为最右侧的叶页和新的默认插入位置。

### 为未来的索引增长预留B树页面空间

要为将来的索引增长预留空间，可以使用Innodb_ill_factor配置选项保留一定百分比的B+树页面空间。例如，将INNODB_FILL_FACTOR设置为80将在排序索引构建期间在B+树页面中保留20%的空间。此设置既适用于B+树叶页面，也适用于非树叶页面。它不适用于用于文本或BLOB条目的外部页面。保留的空间量可能与配置的不完全相同，因为Innodb_ill_factor值被解释为提示而不是硬限制。

### 排序索引构建和全文本索引支持

全文索引支持排序索引生成。以前，SQL用于将条目插入全文索引

### 排序索引构建和压缩表

对于压缩表，前面的索引创建方法将条目同时附加到压缩页和未压缩页。当修改日志(表示压缩页上的可用空间)变满时，将重新压缩压缩页。如果由于空间不足而导致压缩失败，页面将被拆分。使用排序索引构建，条目仅追加到未压缩的页。当未压缩的页面变满时，它将被压缩。在大多数情况下，自适应填充用于确保压缩成功，但如果压缩失败，则会拆分页面并再次尝试压缩。此过程将继续，直到压缩成功。

### 排序索引构建和重做日志记录

在排序索引生成期间禁用重做日志记录。相反，有一个检查点来确保索引构建可以承受意外退出或失败。检查点强制将所有脏页写入磁盘。在排序索引生成期间，页面清理器线程会定期收到刷新脏页的信号，以确保可以快速处理检查点操作。通常，当干净页的数量低于设定的阈值时，页清理器线程会刷新脏页。对于排序索引构建，将立即刷新脏页，以减少检查点开销，并使I/O和CPU活动并行化。

### 排序索引构建和优化器统计

排序的索引构建可能会导致优化器统计信息与以前的索引创建方法生成的统计信息不同。统计数据的差异(预计不会影响工作负载性能)是由于用于填充索引的算法不同造成的。

